<script>
  import { ANIMATION, ATTRIBUTION } from '$lib/constants';
  import { createEventDispatcher, onMount } from 'svelte';
  import Ghost from '$lib/components/ghost/Ghost.svelte';
  
  // Props
  export let transcript = '';
  export let showCopyTooltip = false;
  export let responsiveFontSize = 'text-base';
  
  // Refs
  let editableTranscript;
  let copyButtonRef;
  let transcriptBoxRef;
  
  // State
  let tooltipHoverCount = 0;
  let hasUsedCopyButton = false;
  let isScrollable = false;
  
  // Event dispatcher
  const dispatch = createEventDispatcher();
  
  // Get the current editable content
  export function getEditedTranscript() {
    return editableTranscript ? editableTranscript.innerText : transcript;
  }

  function handleTooltipMouseEnter() {
    if (typeof window !== 'undefined' && 
        window.innerWidth >= 640 &&
        !hasUsedCopyButton &&
        tooltipHoverCount < ANIMATION.COPY.TOOLTIP_MAX_COUNT) {
      showCopyTooltip = true;
      tooltipHoverCount++;
    }
  }
  
  // Check if content is scrollable
  function checkScrollable() {
    if (transcriptBoxRef) {
      isScrollable = transcriptBoxRef.scrollHeight > transcriptBoxRef.clientHeight;
    }
  }
  
  // Browser feature detection
  function isWebShareSupported() {
    return (
      typeof window !== 'undefined' &&
      typeof navigator !== 'undefined' &&
      navigator.share &&
      typeof navigator.share === 'function'
    );
  }
  
  onMount(() => {
    // Check if content is scrollable on mount
    checkScrollable();
    
    // Watch for content changes to update scrollable state
    const resizeObserver = new ResizeObserver(() => {
      checkScrollable();
    });
    
    if (transcriptBoxRef) {
      resizeObserver.observe(transcriptBoxRef);
    }
    
    return () => {
      if (transcriptBoxRef) {
        resizeObserver.unobserve(transcriptBoxRef);
      }
    };
  });
</script>

<div
  class="transcript-wrapper w-full animate-fadeIn-from-top"
  on:animationend={() => {
    // No page scrolling needed anymore with fixed layout
    checkScrollable();
  }}
>
  <div class="wrapper-container flex w-full justify-center">
    <div
      class="transcript-box-container relative mx-auto w-[95%] max-w-[580px] px-0 sm:w-full"
    >
      <!-- Ghost icon copy button positioned outside the transcript box -->
      <button
        class="copy-btn absolute -right-4 -top-4 z-[200] h-10 w-10 rounded-full bg-gradient-to-r from-pink-100 to-purple-50 p-1.5 shadow-lg transition-all duration-200 hover:scale-110 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-pink-300 focus:ring-offset-2 active:scale-95"
        on:click|preventDefault={() => dispatch('copy', { text: getEditedTranscript() })}
        on:mouseenter={handleTooltipMouseEnter}
        on:mouseleave={() => { showCopyTooltip = false; }}
        aria-label="Copy transcript to clipboard"
        bind:this={copyButtonRef}
      >
        <div class="w-full h-full">
          <Ghost 
            size="100%" 
            clickable={false} 
            class="copy-ghost"
            seed={42} 
          />
        </div>

        <!-- Smart tooltip - only shows for first few hovers -->
        {#if showCopyTooltip}
          <div
            class="copy-tooltip absolute right-0 top-12 z-[250] whitespace-nowrap rounded-full bg-white px-3 py-1.5 text-xs font-medium text-purple-800 shadow-md"
          >
            Copy to clipboard
            <div
              class="tooltip-arrow absolute -top-1.5 right-4 h-3 w-3 rotate-45 bg-white"
            ></div>
          </div>
        {/if}
      </button>

      <!-- Redesigned transcript box with proper structure -->
      <div
        class="transcript-box animate-shadow-appear relative mx-auto my-4 box-border 
               rounded-[2rem] border-[1.5px] border-pink-100/70 bg-white/95
               shadow-xl transition-all duration-300 contain-layout"
      >
        <!-- Content Area - scrollable -->
        <div 
          class="transcript-content-area w-full max-h-[320px] overflow-y-auto px-6 pt-5 pb-1 sm:px-8 sm:pt-6 sm:pb-2"
          bind:this={transcriptBoxRef}
        >
          <div
            class={`transcript-text ${responsiveFontSize} text-left custom-transcript-text animate-text-appear font-mono mb-3`}
            contenteditable="true"
            role="textbox"
            aria-label="Transcript editor"
            aria-multiline="true"
            tabindex="0"
            aria-describedby="transcript-instructions"
            bind:this={editableTranscript}
            on:focus={() => {
              dispatch('focus', {
                message: 'You can edit this transcript. Use keyboard to make changes.'
              });
            }}
          >
            {transcript}
          </div>
          
          <!-- Hidden instructions for screen readers -->
          <div id="transcript-instructions" class="sr-only">
            Editable transcript. You can modify the text if needed.
          </div>
        </div>
        
        <!-- Scroll indicator - only visible when scrollable -->
        {#if isScrollable}
          <div
            class="scroll-indicator-bottom pointer-events-none absolute bottom-0 left-0 right-0 z-10"
          ></div>
        {/if}
        
        <!-- Share button area - integrated with content -->
        {#if isWebShareSupported()}
          <div class="transcript-button-area w-full py-3 pb-5">
            <div class="flex w-full justify-center">
              <button
                class="px-5 py-2 text-sm font-medium text-indigo-600 transition-all duration-200 rounded-full shadow-sm share-btn-text bg-gradient-to-r from-indigo-50 to-purple-100 hover:scale-105 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:ring-offset-2 active:scale-95"
                on:click|preventDefault={() => dispatch('share', { text: getEditedTranscript() })}
                aria-label="Share transcript"
              >
                Share
              </button>
            </div>
          </div>
        {/if}
      </div>
    </div>
  </div>
</div>

<style>
  /* Container layout */
  .transcript-wrapper {
    contain: layout;
    margin-top: 32px; /* Space between button and transcript */
  }
  
  /* Box structure */
  .transcript-box {
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Contain all scrolling internally */
  }
  
  /* Enhanced transcript text styling */
  .custom-transcript-text {
    font-size: 17px;
    line-height: 1.65;
    text-align: left;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  
  @media (min-width: 768px) {
    .custom-transcript-text {
      font-size: 18px;
    }
  }
  
  /* Content area scrolling */
  .transcript-content-area {
    scrollbar-width: thin;
    scrollbar-color: rgba(249, 168, 212, 0.5) transparent;
    overscroll-behavior: auto; /* Allow natural overscroll within this container */
    -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
  }
  
  /* Custom scrollbar styles for WebKit browsers */
  .transcript-content-area::-webkit-scrollbar {
    width: 6px;
  }
  
  .transcript-content-area::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .transcript-content-area::-webkit-scrollbar-thumb {
    background-color: rgba(249, 168, 212, 0.5);
    border-radius: 20px;
    border: 2px solid transparent;
  }
  
  /* Visual indicator for scrollable content */
  .scroll-indicator-bottom {
    height: 24px;
    background: linear-gradient(to top, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0) 100%);
    box-shadow: 0 -6px 12px -6px rgba(249, 168, 212, 0.12);
    border-bottom-left-radius: 2rem;
    border-bottom-right-radius: 2rem;
  }
  
  /* Mobile optimization */
  @media (max-width: 600px) {
    .transcript-content-area {
      max-height: 280px; /* Slightly smaller on mobile */
      padding: 1.25rem;
    }
    
    .transcript-content-area::-webkit-scrollbar {
      width: 3px;
    }
    
    .transcript-wrapper {
      margin-top: 24px; /* Smaller gap on mobile */
    }
  }
  
  /* Button area styling - integrated with content */
  .transcript-button-area {
    flex-shrink: 0; /* Prevent button area from shrinking */
    background: transparent; /* Make it blend with content */
    margin-top: -8px; /* Pull it slightly closer to the content */
  }
  
  /* Ensure Share button stays centered */
  :global(.share-btn-text) {
    display: inline-block;
    text-align: center;
  }
  
  /* Animation classes */
  .animate-shadow-appear {
    box-shadow: 0 8px 30px rgba(249, 168, 212, 0.25);
    animation: shadowAppear 0.5s ease-out forwards;
  }
  
  .animate-text-appear {
    animation: textAppear 0.4s ease-out forwards;
  }
  
  @keyframes shadowAppear {
    from {
      box-shadow: 0 0 0 rgba(249, 168, 212, 0);
    }
    to {
      box-shadow: 0 8px 30px rgba(249, 168, 212, 0.25);
    }
  }
  
  @keyframes textAppear {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>